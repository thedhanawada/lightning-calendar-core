<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Calendar Core - Live Demo</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="demo.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>Lightning Calendar Core Demo</h1>
            <nav>
                <a href="index.html">Home</a>
                <a href="#console">Console</a>
                <a href="https://github.com/thedhanawada/lightning-calendar-core">GitHub</a>
            </nav>
        </div>
    </header>

    <main class="demo-main">
        <div class="demo-container">
            <!-- Controls -->
            <section class="controls">
                <div class="control-group">
                    <label>View</label>
                    <div class="button-group">
                        <button data-view="month" class="active">Month</button>
                        <button data-view="week">Week</button>
                        <button data-view="day">Day</button>
                        <button data-view="list">List</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Navigation</label>
                    <div class="button-group">
                        <button id="prev">Previous</button>
                        <button id="today">Today</button>
                        <button id="next">Next</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Timezone</label>
                    <select id="timezone">
                        <option value="America/New_York">New York</option>
                        <option value="America/Chicago">Chicago</option>
                        <option value="America/Los_Angeles">Los Angeles</option>
                        <option value="Europe/London">London</option>
                        <option value="Europe/Paris">Paris</option>
                        <option value="Asia/Tokyo">Tokyo</option>
                        <option value="Asia/Shanghai">Shanghai</option>
                        <option value="Australia/Sydney">Sydney</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Actions</label>
                    <div class="button-group">
                        <button id="detect-conflicts">Detect Conflicts</button>
                        <button id="undo">Undo</button>
                        <button id="redo">Redo</button>
                        <button id="clear">Clear All</button>
                    </div>
                </div>
            </section>

            <!-- Calendar Display -->
            <section class="calendar-display">
                <div id="calendar-header" class="calendar-header"></div>
                <div id="calendar-content" class="calendar-content">
                    <!-- Calendar will be rendered here -->
                </div>
            </section>

            <!-- Side Panel -->
            <aside class="side-panel">
                <!-- Add Event Form -->
                <div class="panel-section">
                    <h3>Add Event</h3>
                    <form id="add-event-form">
                        <div class="form-field">
                            <label>Title</label>
                            <input type="text" id="event-title" required>
                        </div>
                        <div class="form-field">
                            <label>Start</label>
                            <input type="datetime-local" id="event-start" required>
                        </div>
                        <div class="form-field">
                            <label>End</label>
                            <input type="datetime-local" id="event-end" required>
                        </div>
                        <div class="form-field">
                            <label>All Day</label>
                            <input type="checkbox" id="event-allday">
                        </div>
                        <div class="form-field">
                            <label>Recurring</label>
                            <select id="event-recurring">
                                <option value="">None</option>
                                <option value="DAILY">Daily</option>
                                <option value="WEEKLY">Weekly</option>
                                <option value="MONTHLY">Monthly</option>
                            </select>
                        </div>
                        <button type="submit" class="button primary">Add Event</button>
                    </form>
                </div>

                <!-- Statistics -->
                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-value" id="total-events">0</span>
                            <span class="stat-label">Total Events</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="conflicts">0</span>
                            <span class="stat-label">Conflicts</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="undo-count">0</span>
                            <span class="stat-label">Undo Available</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="cache-hits">0</span>
                            <span class="stat-label">Cache Hits</span>
                        </div>
                    </div>
                </div>

                <!-- Event List -->
                <div class="panel-section">
                    <h3>Upcoming Events</h3>
                    <div id="upcoming-events" class="event-list">
                        <p class="empty">No events</p>
                    </div>
                </div>

                <!-- Conflicts -->
                <div class="panel-section">
                    <h3>Detected Conflicts</h3>
                    <div id="conflict-list" class="conflict-list">
                        <p class="empty">No conflicts</p>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Console -->
        <section id="console" class="console">
            <div class="container">
                <h3>Console Output</h3>
                <div id="console-output" class="console-output"></div>
                <div class="console-input">
                    <input type="text" id="console-command" placeholder="Try: calendar.getEvents() or calendar.state.canUndo()">
                    <button id="console-run">Run</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Load the real calendar engine -->
    <script type="module">
        import { Calendar, Event, EventStore } from './dist/calendar-core.esm.js';

        // Make classes available globally for console
        window.Calendar = Calendar;
        window.Event = Event;
        window.EventStore = EventStore;

        class CalendarDemo {
            constructor() {
                this.calendar = new Calendar({
                    view: 'month',
                    timeZone: 'America/New_York',
                    weekStartsOn: 0
                });

                // Expose calendar to console
                window.calendar = this.calendar;

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadSampleEvents();
                this.render();
                this.updateStats();
                this.log('Calendar initialized with real engine');
            }

            setupEventListeners() {
                // View buttons
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.calendar.setView(e.target.dataset.view);
                        this.render();
                        this.log(`View changed to ${e.target.dataset.view}`);
                    });
                });

                // Navigation
                document.getElementById('prev').addEventListener('click', () => {
                    this.calendar.previous();
                    this.render();
                });

                document.getElementById('today').addEventListener('click', () => {
                    this.calendar.today();
                    this.render();
                });

                document.getElementById('next').addEventListener('click', () => {
                    this.calendar.next();
                    this.render();
                });

                // Timezone
                document.getElementById('timezone').addEventListener('change', (e) => {
                    this.calendar.setTimezone(e.target.value);
                    this.render();
                    this.log(`Timezone changed to ${e.target.value}`);
                });

                // Actions
                document.getElementById('detect-conflicts').addEventListener('click', () => {
                    this.detectConflicts();
                });

                document.getElementById('undo').addEventListener('click', () => {
                    if (this.calendar.state.canUndo()) {
                        this.calendar.state.undo();
                        this.render();
                        this.updateStats();
                        this.log('Undo performed');
                    } else {
                        this.log('Nothing to undo');
                    }
                });

                document.getElementById('redo').addEventListener('click', () => {
                    if (this.calendar.state.canRedo()) {
                        this.calendar.state.redo();
                        this.render();
                        this.updateStats();
                        this.log('Redo performed');
                    } else {
                        this.log('Nothing to redo');
                    }
                });

                document.getElementById('clear').addEventListener('click', () => {
                    if (confirm('Clear all events?')) {
                        this.calendar.clearEvents();
                        this.render();
                        this.updateStats();
                        this.log('All events cleared');
                    }
                });

                // Add event form
                document.getElementById('add-event-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addEvent();
                });

                // All day checkbox
                document.getElementById('event-allday').addEventListener('change', (e) => {
                    const startInput = document.getElementById('event-start');
                    const endInput = document.getElementById('event-end');
                    startInput.type = e.target.checked ? 'date' : 'datetime-local';
                    endInput.type = e.target.checked ? 'date' : 'datetime-local';
                });

                // Console
                document.getElementById('console-run').addEventListener('click', () => {
                    this.runCommand();
                });

                document.getElementById('console-command').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.runCommand();
                    }
                });

                // Set default dates
                const now = new Date();
                document.getElementById('event-start').value = now.toISOString().slice(0, 16);
                const end = new Date(now.getTime() + 3600000);
                document.getElementById('event-end').value = end.toISOString().slice(0, 16);
            }

            loadSampleEvents() {
                const today = new Date();

                // Sample events using real Event class
                const events = [
                    new Event({
                        id: '1',
                        title: 'Team Standup',
                        start: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 0),
                        end: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 30),
                        timeZone: 'America/New_York',
                        recurring: true,
                        recurrenceRule: 'FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR'
                    }),
                    new Event({
                        id: '2',
                        title: 'Product Review',
                        start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 14, 0),
                        end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 16, 0),
                        timeZone: 'America/New_York',
                        attendees: [
                            { name: 'John Doe', email: 'john@example.com', responseStatus: 'accepted' },
                            { name: 'Jane Smith', email: 'jane@example.com', responseStatus: 'tentative' }
                        ]
                    }),
                    new Event({
                        id: '3',
                        title: 'All Day Conference',
                        start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 5),
                        end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 5),
                        allDay: true,
                        location: 'Virtual'
                    })
                ];

                // Use batch operation
                this.calendar.eventStore.startBatch();
                events.forEach(event => this.calendar.addEvent(event));
                this.calendar.eventStore.commitBatch();

                this.log(`Loaded ${events.length} sample events`);
            }

            addEvent() {
                const title = document.getElementById('event-title').value;
                const start = new Date(document.getElementById('event-start').value);
                const end = new Date(document.getElementById('event-end').value);
                const allDay = document.getElementById('event-allday').checked;
                const recurring = document.getElementById('event-recurring').value;

                try {
                    const event = new Event({
                        id: `evt-${Date.now()}`,
                        title,
                        start,
                        end,
                        allDay,
                        recurring: !!recurring,
                        recurrenceRule: recurring ? `FREQ=${recurring}` : null,
                        timeZone: this.calendar.getTimezone()
                    });

                    this.calendar.addEvent(event);
                    this.render();
                    this.updateStats();
                    this.updateUpcomingEvents();

                    // Reset form
                    document.getElementById('add-event-form').reset();
                    const now = new Date();
                    document.getElementById('event-start').value = now.toISOString().slice(0, 16);
                    const endTime = new Date(now.getTime() + 3600000);
                    document.getElementById('event-end').value = endTime.toISOString().slice(0, 16);

                    this.log(`Event "${title}" added successfully`);
                } catch (error) {
                    this.log(`Error: ${error.message}`, 'error');
                }
            }

            detectConflicts() {
                const conflicts = this.calendar.eventStore.conflictDetector.findAllConflicts();
                const conflictList = document.getElementById('conflict-list');

                if (conflicts.length === 0) {
                    conflictList.innerHTML = '<p class="empty">No conflicts detected</p>';
                    this.log('No conflicts found');
                } else {
                    conflictList.innerHTML = conflicts.map(conflict => `
                        <div class="conflict-item">
                            <strong>${conflict.type} conflict</strong>
                            <span>${conflict.description}</span>
                            <span class="severity">${conflict.severity}</span>
                        </div>
                    `).join('');
                    this.log(`Found ${conflicts.length} conflicts`);
                }

                document.getElementById('conflicts').textContent = conflicts.length;
            }

            render() {
                const viewData = this.calendar.getViewData();
                const header = document.getElementById('calendar-header');
                const content = document.getElementById('calendar-content');

                // Update header
                header.innerHTML = `<h2>${this.getCalendarTitle(viewData)}</h2>`;

                // Render based on view
                switch (this.calendar.getView()) {
                    case 'month':
                        this.renderMonth(content, viewData);
                        break;
                    case 'week':
                        this.renderWeek(content, viewData);
                        break;
                    case 'day':
                        this.renderDay(content, viewData);
                        break;
                    case 'list':
                        this.renderList(content, viewData);
                        break;
                }

                this.updateUpcomingEvents();
            }

            renderMonth(container, viewData) {
                const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                let html = '<div class="month-view">';
                html += '<div class="weekdays">';
                weekdays.forEach(day => {
                    html += `<div class="weekday">${day}</div>`;
                });
                html += '</div>';

                html += '<div class="month-grid">';
                viewData.weeks.forEach(week => {
                    week.days.forEach(day => {
                        const classes = ['day'];
                        if (day.isToday) classes.push('today');
                        if (!day.isCurrentMonth) classes.push('other-month');
                        if (day.isWeekend) classes.push('weekend');

                        html += `<div class="${classes.join(' ')}">`;
                        html += `<div class="day-number">${day.dayOfMonth}</div>`;

                        if (day.events && day.events.length > 0) {
                            html += '<div class="day-events">';
                            day.events.slice(0, 3).forEach(event => {
                                html += `<div class="event-dot" title="${event.title}"></div>`;
                            });
                            if (day.events.length > 3) {
                                html += `<span class="more">+${day.events.length - 3}</span>`;
                            }
                            html += '</div>';
                        }

                        html += '</div>';
                    });
                });
                html += '</div></div>';

                container.innerHTML = html;
            }

            renderWeek(container, viewData) {
                let html = '<div class="week-view">';

                viewData.days.forEach(day => {
                    const classes = ['week-day'];
                    if (day.isToday) classes.push('today');

                    html += `<div class="${classes.join(' ')}">`;
                    html += `<h4>${day.dayName} ${day.date.getDate()}</h4>`;

                    if (day.events && day.events.length > 0) {
                        html += '<div class="day-events">';
                        day.events.forEach(event => {
                            html += `<div class="event-item">`;
                            html += `<span class="event-time">${this.formatTime(event.start)}</span>`;
                            html += `<span class="event-title">${event.title}</span>`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }

            renderDay(container, viewData) {
                let html = '<div class="day-view">';

                // All day events
                if (viewData.allDayEvents && viewData.allDayEvents.length > 0) {
                    html += '<div class="all-day-events">';
                    html += '<h4>All Day</h4>';
                    viewData.allDayEvents.forEach(event => {
                        html += `<div class="event-item">${event.title}</div>`;
                    });
                    html += '</div>';
                }

                // Hourly slots
                html += '<div class="hour-slots">';
                for (let hour = 0; hour < 24; hour++) {
                    const hourData = viewData.hours[hour];
                    html += `<div class="hour-slot">`;
                    html += `<div class="hour-label">${hour.toString().padStart(2, '0')}:00</div>`;
                    html += '<div class="hour-events">';

                    if (hourData && hourData.events && hourData.events.length > 0) {
                        hourData.events.forEach(event => {
                            html += `<div class="event-item">${event.title}</div>`;
                        });
                    }

                    html += '</div></div>';
                }
                html += '</div>';

                html += '</div>';
                container.innerHTML = html;
            }

            renderList(container, viewData) {
                let html = '<div class="list-view">';

                if (viewData.days && viewData.days.length > 0) {
                    viewData.days.forEach(day => {
                        html += `<div class="list-day">`;
                        html += `<h4>${day.dayName}</h4>`;

                        if (day.events && day.events.length > 0) {
                            day.events.forEach(event => {
                                html += `<div class="event-item">`;
                                html += `<span class="event-time">${this.formatTime(event.start)}</span>`;
                                html += `<span class="event-title">${event.title}</span>`;
                                html += `</div>`;
                            });
                        }

                        html += '</div>';
                    });
                } else {
                    html += '<p class="empty">No events in this range</p>';
                }

                html += '</div>';
                container.innerHTML = html;
            }

            updateStats() {
                const stats = this.calendar.eventStore.getStats();
                document.getElementById('total-events').textContent = stats.totalEvents;
                document.getElementById('undo-count').textContent = this.calendar.state.getUndoCount();

                // Get cache hits from performance optimizer
                const metrics = this.calendar.eventStore.getPerformanceMetrics();
                document.getElementById('cache-hits').textContent = metrics.cacheHits || 0;
            }

            updateUpcomingEvents() {
                const events = this.calendar.getEventsInRange(
                    new Date(),
                    new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                );

                const container = document.getElementById('upcoming-events');
                if (events.length === 0) {
                    container.innerHTML = '<p class="empty">No upcoming events</p>';
                } else {
                    container.innerHTML = events.slice(0, 5).map(event => `
                        <div class="event-item">
                            <span class="event-date">${event.start.toLocaleDateString()}</span>
                            <span class="event-title">${event.title}</span>
                        </div>
                    `).join('');
                }
            }

            getCalendarTitle(viewData) {
                const view = this.calendar.getView();
                const date = this.calendar.state.get('currentDate');

                switch (view) {
                    case 'month':
                        return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    case 'week':
                        return `Week of ${viewData.startDate.toLocaleDateString()}`;
                    case 'day':
                        return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                    case 'list':
                        return 'Event List';
                    default:
                        return '';
                }
            }

            formatTime(date) {
                return date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }

            runCommand() {
                const input = document.getElementById('console-command');
                const command = input.value.trim();

                if (!command) return;

                this.log(`> ${command}`, 'command');

                try {
                    const result = eval(command);
                    this.log(JSON.stringify(result, null, 2), 'result');
                } catch (error) {
                    this.log(`Error: ${error.message}`, 'error');
                }

                input.value = '';
                input.focus();
            }

            log(message, type = 'info') {
                const output = document.getElementById('console-output');
                const entry = document.createElement('div');
                entry.className = `console-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                output.appendChild(entry);
                output.scrollTop = output.scrollHeight;
            }
        }

        // Initialize demo
        const demo = new CalendarDemo();
        window.demo = demo;
    </script>
</body>
</html>